<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Show • TVmaze</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/css/main.css" rel="stylesheet" />
</head>
<body>
  <header class="c-header">
    <div class="c-header__brand"><a href="/">TVmaze App</a></div>
  </header>

  <main class="container">
    <section id="hero" class="section"></section>
    <section class="section">
      <h2 class="section__title">Episodios</h2>
      <div id="episodes"></div>
    </section>
    <section class="section">
      <h2 class="section__title">Elenco</h2>
      <div id="cast" class="c-grid"></div>
    </section>
  </main>

  <script type="module">
    import { $, renderInto, castCard } from "/js/ui.js";
    import { showById } from "/js/api.js";

    const id = new URLSearchParams(location.search).get("id");
    const hero = $("#hero");
    const episodesEl = $("#episodes");
    const castEl = $("#cast");

    renderInto(hero, "<p>Cargando…</p>");
    renderInto(episodesEl, "<p>Cargando…</p>");
    renderInto(castEl, "<p>Cargando…</p>");

    showById(id, ["episodes", "cast"]).then(({data:show})=>{
      const img = show.image?.original || show.image?.medium || "";
      renderInto(hero, `
        <div class="row">
          <img src="${img}" alt="${show.name}" style="max-width:240px;border-radius:var(--radius)">
          <div>
            <h1 class="section__title">${show.name}</h1>
            <p>${show.summary || ""}</p>
            <p class="mt">
              ${show.genres.map(g=>`<span class="c-card__badge">${g}</span>`).join(" ")}
              ${show.rating?.average ? `<span class="c-card__badge">★ ${show.rating.average}</span>` : ""}
            </p>
          </div>
        </div>
      `);
      const bySeason = new Map();
      (show._embedded?.episodes || []).forEach(ep=>{
        const s = ep.season || 0;
        if(!bySeason.has(s)) bySeason.set(s, []);
        bySeason.get(s).push(ep);
      });
      const html = [...bySeason.entries()].sort(([a],[b])=>a-b).map(([season, eps])=>{
        return `
          <details class="mt">
            <summary><b>Temporada ${season}</b> — ${eps.length} episodios</summary>
            <ul class="mt">
              ${eps.map(ep=>`<li>S${ep.season}E${ep.number} — ${ep.name || "(Sin título)"} (${ep.airdate || ""})</li>`).join("")}
            </ul>
          </details>
        `;
      }).join("");
      renderInto(episodesEl, html || "<p>Sin episodios.</p>");

      const cast = show._embedded?.cast || [];
      renderInto(castEl, cast.map(castCard).join("") || "<p>Sin elenco.</p>");
    }).catch(()=> {
      renderInto(hero, "<p>Error cargando show.</p>");
      renderInto(episodesEl, "");
      renderInto(castEl, "");
    });
  </script>
</body>
</html>
